<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>Habit Tracker</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                background: #fff6ed;
                margin: 0;
                padding: 20px;
            }

            h1 {
                text-align: center;
                letter-spacing: 4px;
                color: #234a66;
            }

            .controls {
                text-align: center;
                margin-bottom: 20px;
            }

            select {
                padding: 6px 10px;
                font-size: 16px;
            }

            table {
                border-collapse: collapse;
                width: 100%;
                background: #fff;
            }

            th, td {
                border: 1px solid #234a66;
                text-align: center;
                padding: 6px;
                font-size: 14px;
            }

            th {
                background: #b6cdd6;
                color: #123;
            }

            td.habit-name {
                text-align: left;
                font-weight: bold;
                background: #fbe8dc;
                min-width: 160px;
            }

            td.day {
                cursor: pointer;
                width: 26px;
                height: 26px;
            }

            td.day.done {
                background: #4caf50;
                color: white;
                font-weight: bold;
            }

            td.day:hover {
                background: #dbeef4;
            }

            .add-habit {
                margin-top: 15px;
                text-align: center;
            }

            input {
                padding: 6px;
                font-size: 14px;
            }

            button {
                padding: 6px 12px;
                font-size: 14px;
                cursor: pointer;
            }
        </style>
    </head>
    <body>

        <h1>HABIT TRACKER</h1>

        <div class="controls">
            <label>Select Month: </label>
            <input type="month" id="monthPicker" />
        </div>

        <table id="habitTable">
            <thead>
                <tr id="dayHeader">
                    <th>Habit</th>
                </tr>
            </thead>
            <tbody id="habitBody"></tbody>
        </table>

        <div class="add-habit">
            <input type="text" id="habitInput" placeholder="New habit name" />
            <button onclick="addHabit()">Add Habit</button>
        </div>

        <script>
            const API_BASE = "/api";
            const habitBody = document.getElementById("habitBody");
            const dayHeader = document.getElementById("dayHeader");
            const monthPicker = document.getElementById("monthPicker");

            let habits = [];
            let logs = {};

            // Init current month
            const now = new Date();
            monthPicker.value = now.toISOString().slice(0, 7);

            monthPicker.addEventListener("change", loadData);

            async function loadData() {
                const month = monthPicker.value;
                buildDayHeader(month);
                habits = await fetchJSON(`${API_BASE}/habits`);
                habitBody.innerHTML = "";

                for (const habit of habits) {
                    logs[habit.id] = await fetchJSON(
                            `${API_BASE}/habits/${habit.id}/logs?month=${month}`
                            );
                    renderHabitRow(habit, month);
                }
            }

            function buildDayHeader(month) {
                dayHeader.innerHTML = "<th>Habit</th>";
                const [year, m] = month.split("-");
                const daysInMonth = new Date(year, m, 0).getDate();

                for (let d = 1; d <= daysInMonth; d++) {
                    const th = document.createElement("th");
                    th.textContent = d;
                    dayHeader.appendChild(th);
                }
            }

            function renderHabitRow(habit, month) {
                const tr = document.createElement("tr");

                const nameTd = document.createElement("td");
                nameTd.textContent = habit.name;
                nameTd.className = "habit-name";
                tr.appendChild(nameTd);

                const [year, m] = month.split("-");
                const daysInMonth = new Date(year, m, 0).getDate();

                for (let d = 1; d <= daysInMonth; d++) {
                    const td = document.createElement("td");
                    td.className = "day";

                    const date = `${month}-${String(d).padStart(2, "0")}`;

                    if (logs[habit.id]?.some(l => l.date === date && l.status === 1)) {
                        td.classList.add("done");
                        td.textContent = "✓";
                    }

                    td.onclick = () => toggleHabit(habit.id, date, td);
                    tr.appendChild(td);
                }

                habitBody.appendChild(tr);
            }

            async function toggleHabit(habitId, date, cell) {
                const done = cell.classList.contains("done");

                await fetch(`${API_BASE}/habits/${habitId}/logs`, {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({
                        date: date,
                        status: done ? 0 : 1
                    })
                });

                cell.classList.toggle("done");
                cell.textContent = cell.classList.contains("done") ? "✓" : "";
            }

            async function addHabit() {
                const name = document.getElementById("habitInput").value.trim();
                if (!name)
                    return;

                await fetch(`${API_BASE}/habits`, {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({name})
                });

                document.getElementById("habitInput").value = "";
                loadData();
            }

            async function fetchJSON(url) {
                const res = await fetch(url);
                return await res.json();
            }

            loadData();
        </script>

    </body>
</html>
